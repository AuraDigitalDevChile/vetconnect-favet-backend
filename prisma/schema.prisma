// VetConnect FAVET - Schema de Base de Datos PostgreSQL
// Compatible con Prisma + Next.js 14 + TypeScript
// Fecha: 2025-11-12

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// ENUMS
// ==========================================

enum RolUsuario {
  ADMIN
  VETERINARIO
  RECEPCIONISTA
  ASISTENTE
  CLIENTE
}

enum Especie {
  CANINO
  FELINO
  EXOTICO
  EQUINO
  BOVINO
  OTRO
}

enum Sexo {
  MACHO
  HEMBRA
}

enum EstadoReproductivo {
  ENTERO
  CASTRADO
  ESTERILIZADO
}

enum Tamanio {
  PEQUENO
  MEDIANO
  GRANDE
  GIGANTE
}

enum Caracter {
  DOCIL
  NERVIOSO
  AGRESIVO
  MIEDOSO
}

enum TipoCita {
  CONSULTA_GENERAL
  CONTROL
  VACUNACION
  CIRUGIA
  EMERGENCIA
  TELEMEDICINA
}

enum EstadoCita {
  PROGRAMADA
  CONFIRMADA
  EN_CURSO
  COMPLETADA
  CANCELADA
  NO_ASISTIO
}

enum EstadoFicha {
  EN_CURSO
  CERRADA
}

enum EstadoHospitalizacion {
  ACTIVA
  ALTA
  TRANSFERIDO
  FALLECIDO
}

enum GravedadHospitalizacion {
  LEVE
  MODERADA
  GRAVE
  CRITICA
}

enum EstadoCirugia {
  PROGRAMADA
  EN_CURSO
  FINALIZADA
  CANCELADA
  COMPLICACION
}

enum TipoExamen {
  HEMOGRAMA
  BIOQUIMICA
  RADIOGRAFIA
  ECOGRAFIA
  ELECTROCARDIOGRAMA
  OTRO
}

enum EstadoExamen {
  SOLICITADO
  EN_PROCESO
  COMPLETADO
  CANCELADO
}

enum CategoriaInventario {
  FARMACO
  INSUMO
  PRODUCTO_VENTA
  EQUIPO
  OTRO
}

enum TipoMovimientoInventario {
  INGRESO_COMPRA
  SALIDA_CONSUMO
  SALIDA_VENTA
  AJUSTE_INVENTARIO
  BAJA_VENCIMIENTO
  BAJA_DANO
}

enum EstadoOrdenCompra {
  BORRADOR
  ENVIADA
  RECIBIDA_PARCIAL
  RECIBIDA_COMPLETA
  CANCELADA
}

enum MetodoPago {
  EFECTIVO
  TARJETA_DEBITO
  TARJETA_CREDITO
  TRANSFERENCIA
  CHEQUE
}

enum EstadoFactura {
  PENDIENTE
  PAGADA
  ANULADA
  VENCIDA
}

enum TipoDocumento {
  BOLETA
  FACTURA
  NOTA_CREDITO
  NOTA_DEBITO
}

// ==========================================
// MODELOS PRINCIPALES
// ==========================================

// ------------------------------
// Centros Veterinarios
// ------------------------------

model Centro {
  id                      Int       @id @default(autoincrement())
  nombre                  String    @db.VarChar(200)
  codigo                  String    @unique @db.VarChar(50) // "BILBAO", "EL_ROBLE", "HOSPITAL"
  direccion               String?   @db.VarChar(500)
  telefono                String?   @db.VarChar(50)
  email                   String?   @db.VarChar(200)
  capacidad_usuarios      Int       @default(50)
  activo                  Boolean   @default(true)
  created_at              DateTime  @default(now())
  updated_at              DateTime  @updatedAt

  // Relaciones
  usuarios                Usuario[]
  pacientes               Paciente[]
  citas                   Cita[]
  fichas_clinicas         FichaClinica[]
  hospitalizaciones       Hospitalizacion[]
  cirugias                Cirugia[]
  inventario              Inventario[]
  ordenes_compra          OrdenCompra[]
  facturas                Factura[]
  cajas                   Caja[]
  boxes                   Box[]

  @@map("centros")
}

// ------------------------------
// Usuarios y Staff
// ------------------------------

model Usuario {
  id                      Int       @id @default(autoincrement())
  centro_id               Int
  nombre_completo         String    @db.VarChar(200)
  email                   String    @unique @db.VarChar(200)
  rut                     String    @unique @db.VarChar(20)
  telefono                String?   @db.VarChar(50)
  password_hash           String    @db.VarChar(255)
  rol                     RolUsuario
  activo                  Boolean   @default(true)
  ultimo_acceso           DateTime?
  created_at              DateTime  @default(now())
  updated_at              DateTime  @updatedAt

  // Relaciones
  centro                  Centro    @relation(fields: [centro_id], references: [id], onDelete: Cascade)
  citas_asignadas         Cita[]    @relation("VeterinarioAsignado")
  fichas_clinicas         FichaClinica[]
  hospitalizaciones       Hospitalizacion[]
  cirugias_cirujano       Cirugia[] @relation("CirujanoPrincipal")
  cirugias_anestesista    Cirugia[] @relation("Anestesista")
  cirugias_asistente      Cirugia[] @relation("Asistente")
  horarios                Horario[]
  ausencias               Ausencia[]
  movimientos_inventario  MovimientoInventario[]
  ordenes_compra          OrdenCompra[]
  facturas                Factura[]
  cajas                   Caja[]

  @@index([centro_id])
  @@index([email])
  @@index([rut])
  @@map("usuarios")
}

// ------------------------------
// Tutores/Propietarios
// ------------------------------

model Tutor {
  id                      Int       @id @default(autoincrement())
  nombre_completo         String    @db.VarChar(200)
  rut                     String    @unique @db.VarChar(20)
  email                   String    @db.VarChar(200)
  telefono                String    @db.VarChar(50)
  direccion               String?   @db.VarChar(500)
  comuna                  String?   @db.VarChar(100)
  activo                  Boolean   @default(true)
  notas                   String?   @db.Text
  created_at              DateTime  @default(now())
  updated_at              DateTime  @updatedAt

  // Relaciones
  pacientes               Paciente[]
  citas                   Cita[]
  facturas                Factura[]
  presupuestos            Presupuesto[]

  @@index([rut])
  @@index([email])
  @@map("tutores")
}

// ------------------------------
// Pacientes
// ------------------------------

model Paciente {
  id                      Int       @id @default(autoincrement())
  centro_id               Int
  tutor_id                Int
  numero_ficha            String    @db.VarChar(50) // Consecutivo por centro
  nombre                  String    @db.VarChar(100)
  especie                 Especie
  raza                    String?   @db.VarChar(100)
  sexo                    Sexo
  estado_reproductivo     EstadoReproductivo
  fecha_nacimiento        DateTime?
  edad_estimada_anios     Int?
  edad_estimada_meses     Int?
  peso_kg                 Decimal?  @db.Decimal(6, 2)
  chip                    String?   @unique @db.VarChar(50)
  color                   String?   @db.VarChar(100)
  tamanio                 Tamanio?
  caracter                Caracter?
  habitat                 String?   @db.VarChar(200)
  tipo_alimentacion       String?   @db.VarChar(200)
  fallecido               Boolean   @default(false)
  fecha_fallecimiento     DateTime?
  activo                  Boolean   @default(true)
  foto_url                String?   @db.VarChar(500)
  notas                   String?   @db.Text
  created_at              DateTime  @default(now())
  updated_at              DateTime  @updatedAt

  // Relaciones
  centro                  Centro    @relation(fields: [centro_id], references: [id], onDelete: Cascade)
  tutor                   Tutor     @relation(fields: [tutor_id], references: [id], onDelete: Cascade)
  citas                   Cita[]
  fichas_clinicas         FichaClinica[]
  hospitalizaciones       Hospitalizacion[]
  cirugias                Cirugia[]
  pesos                   RegistroPeso[]
  vacunas                 Vacuna[]
  convenios               ConvenioPaciente[]
  facturas                Factura[]
  examenes                Examen[]
  presupuestos            Presupuesto[]

  @@unique([centro_id, numero_ficha])
  @@index([centro_id])
  @@index([tutor_id])
  @@index([chip])
  @@index([nombre])
  @@map("pacientes")
}

// ------------------------------
// Registro de Peso
// ------------------------------

model RegistroPeso {
  id                      Int       @id @default(autoincrement())
  paciente_id             Int
  peso_kg                 Decimal   @db.Decimal(6, 2)
  fecha_registro          DateTime  @default(now())
  observaciones           String?   @db.Text
  created_at              DateTime  @default(now())

  // Relaciones
  paciente                Paciente  @relation(fields: [paciente_id], references: [id], onDelete: Cascade)

  @@index([paciente_id])
  @@index([fecha_registro])
  @@map("registros_peso")
}

// ------------------------------
// Vacunas
// ------------------------------

model Vacuna {
  id                      Int       @id @default(autoincrement())
  paciente_id             Int
  nombre_vacuna           String    @db.VarChar(200)
  fecha_aplicacion        DateTime
  proxima_dosis           DateTime?
  lote                    String?   @db.VarChar(100)
  veterinario             String?   @db.VarChar(200)
  observaciones           String?   @db.Text
  created_at              DateTime  @default(now())
  updated_at              DateTime  @updatedAt

  // Relaciones
  paciente                Paciente  @relation(fields: [paciente_id], references: [id], onDelete: Cascade)

  @@index([paciente_id])
  @@map("vacunas")
}

// ------------------------------
// Horarios y Agendas
// ------------------------------

model Horario {
  id                      Int       @id @default(autoincrement())
  usuario_id              Int
  dia_semana              Int       // 0 = Domingo, 6 = Sábado
  hora_inicio             String    @db.VarChar(5) // "08:00"
  hora_fin                String    @db.VarChar(5) // "18:00"
  duracion_cita_minutos   Int       @default(30)
  activo                  Boolean   @default(true)
  created_at              DateTime  @default(now())
  updated_at              DateTime  @updatedAt

  // Relaciones
  usuario                 Usuario   @relation(fields: [usuario_id], references: [id], onDelete: Cascade)

  @@index([usuario_id])
  @@map("horarios")
}

model Ausencia {
  id                      Int       @id @default(autoincrement())
  usuario_id              Int
  fecha_inicio            DateTime
  fecha_fin               DateTime
  motivo                  String?   @db.VarChar(500)
  tipo                    String    @db.VarChar(50) // "VACACIONES", "ENFERMEDAD", "PERMISO"
  created_at              DateTime  @default(now())
  updated_at              DateTime  @updatedAt

  // Relaciones
  usuario                 Usuario   @relation(fields: [usuario_id], references: [id], onDelete: Cascade)

  @@index([usuario_id])
  @@map("ausencias")
}

// ------------------------------
// Citas / Agendamiento
// ------------------------------

model Cita {
  id                      Int       @id @default(autoincrement())
  centro_id               Int
  paciente_id             Int
  tutor_id                Int
  veterinario_id          Int
  box_id                  Int?
  tipo                    TipoCita
  fecha                   DateTime
  hora                    String    @db.VarChar(5)
  duracion_minutos        Int       @default(30)
  motivo                  String?   @db.Text
  observaciones           String?   @db.Text
  estado                  EstadoCita @default(PROGRAMADA)
  recordatorio_enviado    Boolean   @default(false)
  confirmada              Boolean   @default(false)
  fecha_confirmacion      DateTime?
  created_at              DateTime  @default(now())
  updated_at              DateTime  @updatedAt

  // Relaciones
  centro                  Centro    @relation(fields: [centro_id], references: [id], onDelete: Cascade)
  paciente                Paciente  @relation(fields: [paciente_id], references: [id], onDelete: Cascade)
  tutor                   Tutor     @relation(fields: [tutor_id], references: [id], onDelete: Cascade)
  veterinario             Usuario   @relation("VeterinarioAsignado", fields: [veterinario_id], references: [id], onDelete: Cascade)
  box                     Box?      @relation(fields: [box_id], references: [id], onDelete: SetNull)
  ficha_clinica           FichaClinica?

  @@index([centro_id])
  @@index([paciente_id])
  @@index([tutor_id])
  @@index([veterinario_id])
  @@index([fecha])
  @@map("citas")
}

// ------------------------------
// Boxes / Caniles / Pabellones
// ------------------------------

model Box {
  id                      Int       @id @default(autoincrement())
  centro_id               Int
  nombre                  String    @db.VarChar(100)
  tipo                    String    @db.VarChar(50) // "CONSULTA", "HOSPITALIZACION", "CIRUGIA"
  capacidad               Int       @default(1)
  activo                  Boolean   @default(true)
  created_at              DateTime  @default(now())
  updated_at              DateTime  @updatedAt

  // Relaciones
  centro                  Centro    @relation(fields: [centro_id], references: [id], onDelete: Cascade)
  citas                   Cita[]
  hospitalizaciones       Hospitalizacion[]
  cirugias                Cirugia[]

  @@index([centro_id])
  @@map("boxes")
}

// ------------------------------
// Fichas Clínicas
// ------------------------------

model FichaClinica {
  id                      Int       @id @default(autoincrement())
  centro_id               Int
  paciente_id             Int
  tutor_id                Int       // Desnormalizado para reportes
  veterinario_id          Int
  cita_id                 Int?      @unique
  fecha_consulta          DateTime  @default(now())
  motivo_consulta         String    @db.Text
  duracion_sintomas       String?   @db.VarChar(200)
  anamnesis_remota        String?   @db.Text
  anamnesis_actual        String    @db.Text
  apetito                 String?   @db.VarChar(200)
  consumo_agua            String?   @db.VarChar(200)
  defecacion              String?   @db.VarChar(200)
  miccion                 String?   @db.VarChar(200)
  antecedentes            String?   @db.Text
  examen_fisico           String?   @db.Text
  temperatura             Decimal?  @db.Decimal(4, 1)
  frecuencia_cardiaca     Int?
  frecuencia_respiratoria Int?
  peso_kg                 Decimal?  @db.Decimal(6, 2)
  prediagnostico          String?   @db.Text
  diagnostico             String?   @db.Text
  tratamiento             String?   @db.Text
  observaciones           String?   @db.Text
  estado                  EstadoFicha @default(EN_CURSO)
  created_at              DateTime  @default(now())
  updated_at              DateTime  @updatedAt

  // Relaciones
  centro                  Centro    @relation(fields: [centro_id], references: [id], onDelete: Cascade)
  paciente                Paciente  @relation(fields: [paciente_id], references: [id], onDelete: Cascade)
  veterinario             Usuario   @relation(fields: [veterinario_id], references: [id], onDelete: Cascade)
  cita                    Cita?     @relation(fields: [cita_id], references: [id], onDelete: SetNull)
  examenes                Examen[]
  recetas                 Receta[]
  insumos_utilizados      InsumoUtilizado[]

  @@index([centro_id])
  @@index([paciente_id])
  @@index([veterinario_id])
  @@index([fecha_consulta])
  @@map("fichas_clinicas")
}

// ------------------------------
// Exámenes
// ------------------------------

model Examen {
  id                      Int       @id @default(autoincrement())
  ficha_clinica_id        Int?
  hospitalizacion_id      Int?
  cirugia_id              Int?
  paciente_id             Int
  tipo                    TipoExamen
  nombre                  String    @db.VarChar(200)
  descripcion             String?   @db.Text
  fecha_solicitud         DateTime  @default(now())
  fecha_realizacion       DateTime?
  estado                  EstadoExamen @default(SOLICITADO)
  resultado_texto         String?   @db.Text
  resultado_archivo_url   String?   @db.VarChar(500)
  precio                  Decimal?  @db.Decimal(10, 2)
  observaciones           String?   @db.Text
  created_at              DateTime  @default(now())
  updated_at              DateTime  @updatedAt

  // Relaciones
  ficha_clinica           FichaClinica? @relation(fields: [ficha_clinica_id], references: [id], onDelete: Cascade)
  hospitalizacion         Hospitalizacion? @relation(fields: [hospitalizacion_id], references: [id], onDelete: Cascade)
  cirugia                 Cirugia?  @relation(fields: [cirugia_id], references: [id], onDelete: Cascade)
  paciente                Paciente  @relation(fields: [paciente_id], references: [id], onDelete: Cascade)

  @@index([ficha_clinica_id])
  @@index([hospitalizacion_id])
  @@index([cirugia_id])
  @@index([paciente_id])
  @@map("examenes")
}

// ------------------------------
// Recetas
// ------------------------------

model Receta {
  id                      Int       @id @default(autoincrement())
  ficha_clinica_id        Int
  contenido               String    @db.Text
  archivo_pdf_url         String?   @db.VarChar(500)
  created_at              DateTime  @default(now())

  // Relaciones
  ficha_clinica           FichaClinica @relation(fields: [ficha_clinica_id], references: [id], onDelete: Cascade)

  @@index([ficha_clinica_id])
  @@map("recetas")
}

// ------------------------------
// Hospitalización
// ------------------------------

model Hospitalizacion {
  id                      Int       @id @default(autoincrement())
  centro_id               Int
  paciente_id             Int
  tutor_id                Int       // Desnormalizado
  veterinario_id          Int
  box_id                  Int?
  fecha_ingreso           DateTime  @default(now())
  fecha_alta              DateTime?
  jaula                   String?   @db.VarChar(100)
  ubicacion               String?   @db.VarChar(200)
  condicion               GravedadHospitalizacion
  prediagnostico          String?   @db.Text
  diagnostico             String?   @db.Text
  tratamiento_general     String?   @db.Text
  observaciones           String?   @db.Text
  estado                  EstadoHospitalizacion @default(ACTIVA)
  dias_hospitalizado      Int?
  created_at              DateTime  @default(now())
  updated_at              DateTime  @updatedAt

  // Relaciones
  centro                  Centro    @relation(fields: [centro_id], references: [id], onDelete: Cascade)
  paciente                Paciente  @relation(fields: [paciente_id], references: [id], onDelete: Cascade)
  veterinario             Usuario   @relation(fields: [veterinario_id], references: [id], onDelete: Cascade)
  box                     Box?      @relation(fields: [box_id], references: [id], onDelete: SetNull)
  signos_vitales          SignosVitales[]
  tratamientos            Tratamiento[]
  examenes                Examen[]
  evoluciones             Evolucion[]
  epicrisis               Epicrisis?

  @@index([centro_id])
  @@index([paciente_id])
  @@index([veterinario_id])
  @@index([estado])
  @@map("hospitalizaciones")
}

// ------------------------------
// Signos Vitales
// ------------------------------

model SignosVitales {
  id                      Int       @id @default(autoincrement())
  hospitalizacion_id      Int
  cirugia_id              Int?
  fecha_registro          DateTime  @default(now())
  temperatura             Decimal?  @db.Decimal(4, 1)
  frecuencia_cardiaca     Int?
  frecuencia_respiratoria Int?
  presion_arterial_media  Int?
  spo2                    Int?
  observaciones           String?   @db.Text
  created_at              DateTime  @default(now())

  // Relaciones
  hospitalizacion         Hospitalizacion @relation(fields: [hospitalizacion_id], references: [id], onDelete: Cascade)
  cirugia                 Cirugia?  @relation(fields: [cirugia_id], references: [id], onDelete: Cascade)

  @@index([hospitalizacion_id])
  @@index([cirugia_id])
  @@map("signos_vitales")
}

// ------------------------------
// Tratamientos
// ------------------------------

model Tratamiento {
  id                      Int       @id @default(autoincrement())
  hospitalizacion_id      Int
  medicamento             String    @db.VarChar(200)
  presentacion            String?   @db.VarChar(100)
  concentracion           String?   @db.VarChar(100)
  dosis                   String    @db.VarChar(200)
  via_administracion      String    @db.VarChar(100)
  frecuencia_horas        Int
  fecha_inicio            DateTime
  fecha_fin               DateTime?
  responsable             String?   @db.VarChar(200)
  cobrar                  Boolean   @default(true)
  observaciones           String?   @db.Text
  created_at              DateTime  @default(now())
  updated_at              DateTime  @updatedAt

  // Relaciones
  hospitalizacion         Hospitalizacion @relation(fields: [hospitalizacion_id], references: [id], onDelete: Cascade)
  aplicaciones            AplicacionTratamiento[]

  @@index([hospitalizacion_id])
  @@map("tratamientos")
}

model AplicacionTratamiento {
  id                      Int       @id @default(autoincrement())
  tratamiento_id          Int
  fecha_hora_programada   DateTime
  fecha_hora_aplicada     DateTime?
  aplicado                Boolean   @default(false)
  responsable             String?   @db.VarChar(200)
  observaciones           String?   @db.Text
  created_at              DateTime  @default(now())

  // Relaciones
  tratamiento             Tratamiento @relation(fields: [tratamiento_id], references: [id], onDelete: Cascade)

  @@index([tratamiento_id])
  @@index([fecha_hora_programada])
  @@map("aplicaciones_tratamiento")
}

// ------------------------------
// Evoluciones
// ------------------------------

model Evolucion {
  id                      Int       @id @default(autoincrement())
  hospitalizacion_id      Int
  fecha_registro          DateTime  @default(now())
  usuario                 String    @db.VarChar(200)
  descripcion             String    @db.Text
  created_at              DateTime  @default(now())

  // Relaciones
  hospitalizacion         Hospitalizacion @relation(fields: [hospitalizacion_id], references: [id], onDelete: Cascade)

  @@index([hospitalizacion_id])
  @@map("evoluciones")
}

// ------------------------------
// Epicrisis (Ficha de Derivación)
// ------------------------------

model Epicrisis {
  id                      Int       @id @default(autoincrement())
  hospitalizacion_id      Int       @unique
  gravedad                GravedadHospitalizacion
  prediagnosticos         String    @db.Text
  tratamientos_aplicados  String    @db.Text
  examenes_recomendados   String?   @db.Text
  tratamientos_recomendados String? @db.Text
  observaciones_especiales String?  @db.Text
  archivo_pdf_url         String?   @db.VarChar(500)
  created_at              DateTime  @default(now())
  updated_at              DateTime  @updatedAt

  // Relaciones
  hospitalizacion         Hospitalizacion @relation(fields: [hospitalizacion_id], references: [id], onDelete: Cascade)

  @@map("epicrisis")
}

// ------------------------------
// Cirugías
// ------------------------------

model Cirugia {
  id                      Int       @id @default(autoincrement())
  centro_id               Int
  paciente_id             Int
  tutor_id                Int       // Desnormalizado
  cirujano_id             Int
  anestesista_id          Int?
  asistente_id            Int?
  box_id                  Int?
  procedimiento           String    @db.VarChar(300)
  descripcion             String?   @db.Text
  fecha                   DateTime
  hora_inicio             String?   @db.VarChar(5)
  hora_fin                String?   @db.VarChar(5)
  duracion_minutos        Int?
  sala                    String?   @db.VarChar(100)
  estado                  EstadoCirugia @default(PROGRAMADA)
  evaluacion_preanestesica String?  @db.Text
  preanestesia            String?   @db.Text
  induccion               String?   @db.Text
  mantencion              String?   @db.Text
  complicaciones          String?   @db.Text
  reporte_quirurgico      String?   @db.Text
  reporte_anestesico      String?   @db.Text
  observaciones           String?   @db.Text
  archivo_pdf_url         String?   @db.VarChar(500)
  created_at              DateTime  @default(now())
  updated_at              DateTime  @updatedAt

  // Relaciones
  centro                  Centro    @relation(fields: [centro_id], references: [id], onDelete: Cascade)
  paciente                Paciente  @relation(fields: [paciente_id], references: [id], onDelete: Cascade)
  cirujano                Usuario   @relation("CirujanoPrincipal", fields: [cirujano_id], references: [id], onDelete: Cascade)
  anestesista             Usuario?  @relation("Anestesista", fields: [anestesista_id], references: [id], onDelete: SetNull)
  asistente               Usuario?  @relation("Asistente", fields: [asistente_id], references: [id], onDelete: SetNull)
  box                     Box?      @relation(fields: [box_id], references: [id], onDelete: SetNull)
  signos_vitales          SignosVitales[]
  examenes                Examen[]
  insumos_utilizados      InsumoUtilizado[]

  @@index([centro_id])
  @@index([paciente_id])
  @@index([cirujano_id])
  @@index([fecha])
  @@map("cirugias")
}

// ------------------------------
// Convenios y Planes de Salud
// ------------------------------

model Convenio {
  id                      Int       @id @default(autoincrement())
  nombre                  String    @db.VarChar(200)
  descripcion             String?   @db.Text
  descuento_examenes      Decimal   @default(0) @db.Decimal(5, 2)
  descuento_procedimientos Decimal  @default(0) @db.Decimal(5, 2)
  descuento_productos     Decimal   @default(0) @db.Decimal(5, 2)
  descuento_cirugias      Decimal   @default(0) @db.Decimal(5, 2)
  descuento_hospitalizacion Decimal @default(0) @db.Decimal(5, 2)
  activo                  Boolean   @default(true)
  created_at              DateTime  @default(now())
  updated_at              DateTime  @updatedAt

  // Relaciones
  pacientes               ConvenioPaciente[]

  @@map("convenios")
}

model ConvenioPaciente {
  id                      Int       @id @default(autoincrement())
  paciente_id             Int
  convenio_id             Int
  fecha_inicio            DateTime
  fecha_fin               DateTime?
  activo                  Boolean   @default(true)
  created_at              DateTime  @default(now())
  updated_at              DateTime  @updatedAt

  // Relaciones
  paciente                Paciente  @relation(fields: [paciente_id], references: [id], onDelete: Cascade)
  convenio                Convenio  @relation(fields: [convenio_id], references: [id], onDelete: Cascade)

  @@index([paciente_id])
  @@index([convenio_id])
  @@map("convenios_pacientes")
}

// ------------------------------
// Inventario
// ------------------------------

model Inventario {
  id                      Int       @id @default(autoincrement())
  centro_id               Int
  sku_interno             String    @unique @db.VarChar(100)
  codigo_barras           String?   @unique @db.VarChar(100)
  nombre                  String    @db.VarChar(300)
  categoria               CategoriaInventario
  descripcion             String?   @db.Text
  unidad_medida           String    @db.VarChar(50)
  unidad_compra           String?   @db.VarChar(50)
  factor_conversion       Int       @default(1) // Ej: 1 caja = 20 unidades
  stock_actual            Int       @default(0)
  stock_minimo            Int       @default(0)
  precio_compra           Decimal   @db.Decimal(10, 2)
  precio_venta            Decimal   @db.Decimal(10, 2)
  es_farmaco              Boolean   @default(false)
  presentacion            String?   @db.VarChar(200)
  concentracion           String?   @db.VarChar(200)
  volumen                 String?   @db.VarChar(100)
  es_multidosis           Boolean   @default(false)
  fecha_vencimiento       DateTime?
  lote                    String?   @db.VarChar(100)
  activo                  Boolean   @default(true)
  created_at              DateTime  @default(now())
  updated_at              DateTime  @updatedAt

  // Relaciones
  centro                  Centro    @relation(fields: [centro_id], references: [id], onDelete: Cascade)
  movimientos             MovimientoInventario[]
  items_orden_compra      ItemOrdenCompra[]
  insumos_utilizados      InsumoUtilizado[]

  @@index([centro_id])
  @@index([categoria])
  @@index([sku_interno])
  @@index([codigo_barras])
  @@map("inventario")
}

// ------------------------------
// Movimientos de Inventario
// ------------------------------

model MovimientoInventario {
  id                      Int       @id @default(autoincrement())
  inventario_id           Int
  usuario_id              Int
  tipo                    TipoMovimientoInventario
  cantidad                Int
  origen                  String?   @db.VarChar(200)
  observaciones           String?   @db.Text
  fecha_movimiento        DateTime  @default(now())
  created_at              DateTime  @default(now())

  // Relaciones
  inventario              Inventario @relation(fields: [inventario_id], references: [id], onDelete: Cascade)
  usuario                 Usuario   @relation(fields: [usuario_id], references: [id], onDelete: Cascade)

  @@index([inventario_id])
  @@index([usuario_id])
  @@index([fecha_movimiento])
  @@map("movimientos_inventario")
}

// ------------------------------
// Insumos Utilizados (Vínculo con Fichas/Cirugías)
// ------------------------------

model InsumoUtilizado {
  id                      Int       @id @default(autoincrement())
  inventario_id           Int
  ficha_clinica_id        Int?
  cirugia_id              Int?
  cantidad                Int
  precio_unitario         Decimal   @db.Decimal(10, 2)
  cobrado                 Boolean   @default(true)
  observaciones           String?   @db.Text
  created_at              DateTime  @default(now())

  // Relaciones
  inventario              Inventario @relation(fields: [inventario_id], references: [id], onDelete: Cascade)
  ficha_clinica           FichaClinica? @relation(fields: [ficha_clinica_id], references: [id], onDelete: Cascade)
  cirugia                 Cirugia?  @relation(fields: [cirugia_id], references: [id], onDelete: Cascade)

  @@index([inventario_id])
  @@index([ficha_clinica_id])
  @@index([cirugia_id])
  @@map("insumos_utilizados")
}

// ------------------------------
// Proveedores
// ------------------------------

model Proveedor {
  id                      Int       @id @default(autoincrement())
  rut                     String    @unique @db.VarChar(20)
  razon_social            String    @db.VarChar(300)
  nombre_contacto         String?   @db.VarChar(200)
  telefono                String?   @db.VarChar(50)
  email                   String?   @db.VarChar(200)
  direccion               String?   @db.VarChar(500)
  vendedor_asignado       String?   @db.VarChar(200)
  activo                  Boolean   @default(true)
  created_at              DateTime  @default(now())
  updated_at              DateTime  @updatedAt

  // Relaciones
  ordenes_compra          OrdenCompra[]

  @@index([rut])
  @@map("proveedores")
}

// ------------------------------
// Órdenes de Compra
// ------------------------------

model OrdenCompra {
  id                      Int       @id @default(autoincrement())
  centro_id               Int
  proveedor_id            Int
  usuario_id              Int       // Quien genera la orden
  numero_orden            String    @unique @db.VarChar(50)
  fecha_emision           DateTime  @default(now())
  fecha_recepcion         DateTime?
  estado                  EstadoOrdenCompra @default(BORRADOR)
  subtotal                Decimal   @db.Decimal(12, 2)
  iva                     Decimal   @db.Decimal(12, 2)
  total                   Decimal   @db.Decimal(12, 2)
  observaciones           String?   @db.Text
  archivo_pdf_url         String?   @db.VarChar(500)
  created_at              DateTime  @default(now())
  updated_at              DateTime  @updatedAt

  // Relaciones
  centro                  Centro    @relation(fields: [centro_id], references: [id], onDelete: Cascade)
  proveedor               Proveedor @relation(fields: [proveedor_id], references: [id], onDelete: Cascade)
  usuario                 Usuario   @relation(fields: [usuario_id], references: [id], onDelete: Cascade)
  items                   ItemOrdenCompra[]

  @@index([centro_id])
  @@index([proveedor_id])
  @@index([usuario_id])
  @@map("ordenes_compra")
}

model ItemOrdenCompra {
  id                      Int       @id @default(autoincrement())
  orden_compra_id         Int
  inventario_id           Int
  cantidad                Int
  precio_unitario         Decimal   @db.Decimal(10, 2)
  subtotal                Decimal   @db.Decimal(12, 2)
  created_at              DateTime  @default(now())

  // Relaciones
  orden_compra            OrdenCompra @relation(fields: [orden_compra_id], references: [id], onDelete: Cascade)
  inventario              Inventario @relation(fields: [inventario_id], references: [id], onDelete: Cascade)

  @@index([orden_compra_id])
  @@index([inventario_id])
  @@map("items_orden_compra")
}

// ------------------------------
// Facturación y POS
// ------------------------------

model Factura {
  id                      Int       @id @default(autoincrement())
  centro_id               Int
  paciente_id             Int
  tutor_id                Int
  usuario_id              Int       // Quien emite
  numero_factura          String    @unique @db.VarChar(50)
  tipo_documento          TipoDocumento
  fecha_emision           DateTime  @default(now())
  fecha_vencimiento       DateTime?
  fecha_pago              DateTime?
  subtotal                Decimal   @db.Decimal(12, 2)
  descuento               Decimal   @default(0) @db.Decimal(10, 2)
  iva                     Decimal   @default(0) @db.Decimal(10, 2)
  total                   Decimal   @db.Decimal(12, 2)
  metodo_pago             MetodoPago?
  estado                  EstadoFactura @default(PENDIENTE)
  observaciones           String?   @db.Text
  archivo_pdf_url         String?   @db.VarChar(500)
  folio_sii               String?   @db.VarChar(50)
  created_at              DateTime  @default(now())
  updated_at              DateTime  @updatedAt

  // Relaciones
  centro                  Centro    @relation(fields: [centro_id], references: [id], onDelete: Cascade)
  paciente                Paciente  @relation(fields: [paciente_id], references: [id], onDelete: Cascade)
  tutor                   Tutor     @relation(fields: [tutor_id], references: [id], onDelete: Cascade)
  usuario                 Usuario   @relation(fields: [usuario_id], references: [id], onDelete: Cascade)
  items                   ItemFactura[]

  @@index([centro_id])
  @@index([paciente_id])
  @@index([tutor_id])
  @@index([usuario_id])
  @@index([fecha_emision])
  @@map("facturas")
}

model ItemFactura {
  id                      Int       @id @default(autoincrement())
  factura_id              Int
  tipo_item               String    @db.VarChar(50) // "SERVICIO", "PRODUCTO", "EXAMEN", "PROCEDIMIENTO"
  descripcion             String    @db.VarChar(500)
  cantidad                Int       @default(1)
  precio_unitario         Decimal   @db.Decimal(10, 2)
  descuento               Decimal   @default(0) @db.Decimal(5, 2)
  subtotal                Decimal   @db.Decimal(12, 2)
  created_at              DateTime  @default(now())

  // Relaciones
  factura                 Factura   @relation(fields: [factura_id], references: [id], onDelete: Cascade)

  @@index([factura_id])
  @@map("items_factura")
}

// ------------------------------
// Caja
// ------------------------------

model Caja {
  id                      Int       @id @default(autoincrement())
  centro_id               Int
  usuario_id              Int       // Responsable
  fecha_apertura          DateTime  @default(now())
  fecha_cierre            DateTime?
  monto_inicial           Decimal   @db.Decimal(12, 2)
  total_ingresos          Decimal   @default(0) @db.Decimal(12, 2)
  total_egresos           Decimal   @default(0) @db.Decimal(12, 2)
  monto_esperado          Decimal?  @db.Decimal(12, 2)
  monto_real              Decimal?  @db.Decimal(12, 2)
  diferencia              Decimal?  @db.Decimal(12, 2)
  observaciones           String?   @db.Text
  cerrada                 Boolean   @default(false)
  created_at              DateTime  @default(now())
  updated_at              DateTime  @updatedAt

  // Relaciones
  centro                  Centro    @relation(fields: [centro_id], references: [id], onDelete: Cascade)
  usuario                 Usuario   @relation(fields: [usuario_id], references: [id], onDelete: Cascade)
  movimientos             MovimientoCaja[]

  @@index([centro_id])
  @@index([usuario_id])
  @@index([fecha_apertura])
  @@map("cajas")
}

model MovimientoCaja {
  id                      Int       @id @default(autoincrement())
  caja_id                 Int
  tipo                    String    @db.VarChar(50) // "INGRESO", "EGRESO"
  monto                   Decimal   @db.Decimal(12, 2)
  concepto                String    @db.VarChar(300)
  metodo_pago             MetodoPago?
  observaciones           String?   @db.Text
  fecha_movimiento        DateTime  @default(now())
  created_at              DateTime  @default(now())

  // Relaciones
  caja                    Caja      @relation(fields: [caja_id], references: [id], onDelete: Cascade)

  @@index([caja_id])
  @@index([fecha_movimiento])
  @@map("movimientos_caja")
}

// ------------------------------
// Presupuestos
// ------------------------------

model Presupuesto {
  id                      Int       @id @default(autoincrement())
  paciente_id             Int
  tutor_id                Int
  numero_presupuesto      String    @unique @db.VarChar(50)
  fecha_emision           DateTime  @default(now())
  fecha_vencimiento       DateTime?
  descripcion             String    @db.Text
  subtotal                Decimal   @db.Decimal(12, 2)
  descuento               Decimal   @default(0) @db.Decimal(10, 2)
  total                   Decimal   @db.Decimal(12, 2)
  condiciones             String?   @db.Text
  aprobado                Boolean?
  archivo_pdf_url         String?   @db.VarChar(500)
  created_at              DateTime  @default(now())
  updated_at              DateTime  @updatedAt

  // Relaciones
  paciente                Paciente  @relation(fields: [paciente_id], references: [id], onDelete: Cascade)
  tutor                   Tutor     @relation(fields: [tutor_id], references: [id], onDelete: Cascade)
  items                   ItemPresupuesto[]

  @@index([paciente_id])
  @@index([tutor_id])
  @@map("presupuestos")
}

model ItemPresupuesto {
  id                      Int       @id @default(autoincrement())
  presupuesto_id          Int
  tipo_item               String    @db.VarChar(50)
  descripcion             String    @db.VarChar(500)
  cantidad                Int       @default(1)
  precio_unitario         Decimal   @db.Decimal(10, 2)
  subtotal                Decimal   @db.Decimal(12, 2)
  created_at              DateTime  @default(now())

  // Relaciones
  presupuesto             Presupuesto @relation(fields: [presupuesto_id], references: [id], onDelete: Cascade)

  @@index([presupuesto_id])
  @@map("items_presupuesto")
}

// ------------------------------
// Auditoría de Cambios
// ------------------------------

model AuditLog {
  id                      Int       @id @default(autoincrement())
  usuario_id              Int?
  tabla                   String    @db.VarChar(100)
  registro_id             Int
  accion                  String    @db.VarChar(50) // "CREATE", "UPDATE", "DELETE"
  datos_anteriores        String?   @db.Text
  datos_nuevos            String?   @db.Text
  ip_address              String?   @db.VarChar(50)
  user_agent              String?   @db.VarChar(500)
  fecha_accion            DateTime  @default(now())

  @@index([usuario_id])
  @@index([tabla])
  @@index([fecha_accion])
  @@map("audit_logs")
}
